<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle da Distribui√ß√£o</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header -->
<header class="header-custom py-3">
    <div class="container text-center">
        <h1 class="mb-1">GERAI</h1>
        <img src="{{ url_for('static', filename='envelope.png') }}" alt="Logo" class="logo-header" style="height:48px">

        <!-- Formul√°rio EPTC -->
        <form method="POST" class="row g-2 justify-content-center mt-3">
            <input type="hidden" name="calcular_eptc" value="1">
            
            <div class="col-auto">
                <label for="total_objetos" class="col-form-label">Qtd. Objetos:</label>
            </div>
            <div class="col-auto">
                <input type="number" name="total_objetos" id="total_objetos" class="form-control" required>
            </div>
        
            <div class="col-auto">
                <label for="ausentes" class="col-form-label">Ausentes at√© o momento:</label>
            </div>
            <div class="col-auto">
                <input type="number" name="ausentes" id="ausentes" class="form-control" required>
            </div>
        
            <div class="col-auto">
                <button type="submit" class="btn btn-warning fw-semibold">
                    <i class="bi bi-calculator"></i> Calcular EPTC
                </button>
            </div>
        </form>
        <!-- Resultado -->
        {% if eptc_estimado > 0 %}
        <div class="alert alert-info mt-3 mb-0">
            <strong>üìä EPTC Previsto:</strong> {{ "%.2f"|format(eptc_estimado) }}% |
            <strong>üîÑ Limite Ausentes:</strong> {{ "%.2f"|format(limite_maximo) }} |
            <strong>üéØ Ausentes at√© o momento:</strong> {{ "%.2f"|format(ausentes_ajustados) }}
        </div>
        {% endif %}
    </div>
</header>
    <!-- ===========================
     CARD DE PREVIS√ÉO DO TEMPO (colocar AQUI: abaixo do EPTC e acima da linha "Data atual")
     Presidente Prudente - SP
     coords: -22.12583, -51.38889
     =========================== -->
    <div class="container my-2" id="climaContainer" style="max-width:980px;">
      <div id="climaCard" class="card card-clima p-3 shadow-sm" style="display:none;">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div id="climaTitulo" class="h6 mb-1"><i id="climaIcon" class="bi ico-clima"></i> <span id="climaLocal">Previs√£o do tempo ‚Äî Presidente Prudente, SP</span></div>
            <div id="climaResumo" class="small text-muted">Atualizando...</div>
          </div>
          <div class="text-end">
            <div id="climaTemp" class="fs-3 fw-bold">-- ¬∞C</div>
            <div id="climaDetalhe" class="small">Vento: -- km/h ‚Ä¢ Chuva: --</div>
          </div>
        </div>
        <hr>
        <div id="climaHoras" class="d-flex gap-2 overflow-auto"></div>
      </div>
    </div>
    
    <!-- camadas de efeito (ser√£o criadas pelo JS quando necess√°rio) -->
    <div id="efeitosClimaContainer"></div>
    
    <script>
    /* CONFIGURA√á√ÉO DO CLIMA (Pres. Prudente) */
    const CLIMA = { lat: -22.12583, lon: -51.38889, timezone: "America/Sao_Paulo" };
    
    function mapaWeatherCode(code) {
      if (code === 0) return {cond: "C√©u limpo", icon: "bi-brightness-high-fill", theme: "clima-solar"};
      if ([1,2,3].includes(code)) return {cond: "Parcialmente nublado", icon: "bi-cloud-sun", theme: "clima-nublado"};
      if ([45,48].includes(code)) return {cond: "Neblina", icon: "bi-cloud-fog", theme: "clima-neblina"};
      if ([51,53,55,56,57].includes(code)) return {cond: "Chuvisco", icon: "bi-cloud-drizzle", theme: "clima-chuva"};
      if ([61,63,65,66,67].includes(code)) return {cond: "Chuva", icon: "bi-cloud-rain", theme: "clima-chuva"};
      if ([80,81,82].includes(code)) return {cond: "Pancadas/Chuva", icon: "bi-cloud-lightning-rain", theme: "clima-chuva"};
      if ([95,96,99].includes(code)) return {cond: "Trovoadas", icon: "bi-cloud-lightning", theme: "clima-tempestade"};
      return {cond: "Nublado", icon: "bi-cloud", theme: "clima-nublado"};
    }
    
    function createRainLayer(intensity) {
      // intensity: "light" | "heavy"
      const container = document.createElement('div');
      container.className = 'rain-layer';
      // cria v√°rias "gotas" com posi√ß√µes aleat√≥rias
      const count = intensity === 'heavy' ? 36 : 14;
      for (let i=0;i<count;i++){
        const s = document.createElement('span');
        s.style.left = (Math.random()*100) + '%';
        s.style.animationDuration = (2 + Math.random()*1.4) + 's';
        s.style.opacity = (0.04 + Math.random()*0.08);
        s.style.height = (20 + Math.random()*30) + 'vh';
        container.appendChild(s);
      }
      return container;
    }
    
    function createLightning() {
      const el = document.createElement('div');
      el.className = 'lightning';
      return el;
    }
    
    async function carregarClima() {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${CLIMA.lat}&longitude=${CLIMA.lon}&current_weather=true&hourly=precipitation_probability,temperature_2m,precipitation&forecast_days=1&timezone=${encodeURIComponent(CLIMA.timezone)}`;
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (!data || !data.current_weather) return;
    
        const cw = data.current_weather;
        const temp = cw.temperature;
        const wind = cw.windspeed;
        const code = cw.weathercode;
        const horaAtualISO = cw.time; // ex: "2025-11-15T14:00"
    
        // 1) probabilidade (procura √≠ndice alinhado)
        let prob = null;
        if (data.hourly && Array.isArray(data.hourly.time) && Array.isArray(data.hourly.precipitation_probability)) {
          const idx = data.hourly.time.indexOf(horaAtualISO);
          const pVal = (idx >= 0) ? data.hourly.precipitation_probability[idx] : data.hourly.precipitation_probability[0];
          prob = (typeof pVal === 'number') ? pVal : null;
        }
    
        // 2) precipita√ß√£o em mm (hourly.precipitation) - para saber se j√° est√° chovendo
        let precip_mm = null;
        if (data.hourly && Array.isArray(data.hourly.time) && Array.isArray(data.hourly.precipitation)) {
          const idx2 = data.hourly.time.indexOf(horaAtualISO);
          const prVal = (idx2 >= 0) ? data.hourly.precipitation[idx2] : data.hourly.precipitation[0];
          precip_mm = (typeof prVal === 'number') ? prVal : null;
        }
    
        const m = mapaWeatherCode(code);
        const card = document.getElementById("climaCard");
        const titulo = document.getElementById("climaTitulo");
        const resumo = document.getElementById("climaResumo");
        const tempEl = document.getElementById("climaTemp");
        const detalhe = document.getElementById("climaDetalhe");
        const horas = document.getElementById("climaHoras");
        const iconEl = document.getElementById("climaIcon");
    
        // icone (com fallback se classe inv√°lida)
        iconEl.className = 'bi ico-clima ' + m.icon;
    
        titulo.querySelector('#climaLocal')?.replaceWith?.(document.getElementById('climaLocal') || document.createElement('span'));
        // conte√∫do
        resumo.textContent = `${m.cond} ‚Ä¢ Atualizado: ${horaAtualISO.replace("T"," ")}`;
        tempEl.textContent = `${Math.round(temp)}¬∞C`;
    
        // detalhe: se precip_mm > 0 mostramos mm; caso contr√°rio mostramos probabilidade arredondada
        let detalheTexto = `Vento: ${Math.round(wind)} km/h`;
        if (precip_mm !== null && precip_mm > 0.01) {
          detalheTexto += ` ‚Ä¢ Chuva: ${precip_mm.toFixed(1)} mm`;
        } else if (prob !== null) {
          const pRounded = (prob < 1 && prob > 0) ? '<1%' : (prob === null ? '--' : Math.round(prob) + '%');
          detalheTexto += ` ‚Ä¢ Chuva: ${pRounded}`;
        } else {
          detalheTexto += ` ‚Ä¢ Chuva: --`;
        }
        detalhe.textContent = detalheTexto;
    
        // Horas: pr√≥ximas 6 horas (mesma l√≥gica do anterior)
        horas.innerHTML = '';
        if (data.hourly && Array.isArray(data.hourly.time)) {
          const times = data.hourly.time;
          const temps = data.hourly.temperature_2m || [];
          const probs = data.hourly.precipitation_probability || [];
          let start = Math.max(0, times.indexOf(horaAtualISO));
          if (start === -1) start = 0;
          for (let i = start; i < Math.min(times.length, start + 6); i++){
            const hourLabel = times[i].split('T')[1].slice(0,5);
            const t = temps[i] !== undefined ? Math.round(temps[i]) + '¬∞C' : '--';
            const p = probs[i] !== undefined ? (probs[i] < 1 && probs[i] > 0 ? '<1%' : Math.round(probs[i]) + '%') : '--';
            const div = document.createElement('div');
            div.className = 'text-center p-2 bg-white rounded shadow-sm flex-shrink-0';
            div.style.minWidth = '110px';
            div.innerHTML = `<div class="fw-bold">${hourLabel}</div><div class="small">${t}</div><div class="small text-muted prob-chuva">Chuva: ${p}</div>`;
            horas.appendChild(div);
          }
        }
    
        // tema visual: remove classes antigas e adiciona a atual
        document.body.classList.remove('clima-solar','clima-nublado','clima-chuva','clima-tempestade','clima-neblina');
        document.body.classList.add(m.theme);
        card.className = 'card card-clima p-3 shadow-sm';
        card.style.display = 'block';
    
        // efeitos visuais: remove efeitos antigos
        const efe = document.getElementById('efeitosClimaContainer');
        efe.innerHTML = '';
    
        // decide intensidade dos efeitos baseado em precip_mm ou prob
        if (m.theme === 'clima-chuva') {
          // se precip >= 1 mm/h -> heavy, sen√£o light
          const intensity = (precip_mm !== null && precip_mm >= 1) ? 'heavy' : 'light';
          efe.appendChild(createRainLayer(intensity));
        }
        if (m.theme === 'clima-tempestade') {
          // rain + lightning
          efe.appendChild(createRainLayer('heavy'));
          efe.appendChild(createLightning());
        }
    
      } catch (err) {
        console.error('Erro ao buscar previs√£o do tempo:', err);
      }
    }
    
    /* inicializa e atualiza a cada 15 minutos */
    carregarClima();
    setInterval(carregarClima, 1000 * 60 * 15);
    </script>


<div class="container my-4">
    <p class="text-muted text-center">Data atual: <strong>{{ data }}</strong></p>

    <!-- Painel Resumo -->
    <div id="painelResumo" class="d-flex flex-wrap mb-4 gap-3 justify-content-center">
        <!-- Cards do resumo via JS -->
    </div>

    <!-- Mensagem sobre o lado do dia -->
    {% if lado_bloqueado %}
    <p class="text-danger text-center fw-semibold">
        As entregas do lado {{ lado_sugerido }} j√° foram atualizadas hoje. Voc√™ s√≥ pode alterar observa√ß√µes.
    </p>
    {% else %}
    <p class="text-success text-center fw-semibold">
        Atualize as entregas do lado {{ lado_sugerido }} hoje.
    </p>
    {% endif %}

    {% if mensagem %}
      {% if "j√° foi atualizado" in mensagem %}
        <div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
          <strong>‚ö† Aten√ß√£o!</strong> {{ mensagem }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% else %}
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
          <strong>‚úî Sucesso!</strong> {{ mensagem }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
    {% endif %}


    <!-- Formul√°rio √∫nico -->
    <form method="POST" id="form-regioes" class="mb-4">
        <div class="mb-3 text-center">
            <label for="lado" class="form-label fw-semibold me-2">Selecione o lado:</label>
            <select class="form-select w-auto d-inline-block" id="lado" name="lado" {% if lado_bloqueado %} disabled {% endif %}>
                <option value="A" {% if lado_sugerido == "A" %}selected{% endif %}>Lado A</option>
                <option value="B" {% if lado_sugerido == "B" %}selected{% endif %}>Lado B</option>
            </select>
        </div>

        <!-- Bot√µes de a√ß√£o -->
        <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-secondary" id="selecionarTodosBtn" {% if lado_bloqueado %} disabled {% endif %}>
                <i class="bi bi-check2-square"></i> Selecionar Todos
            </button>
            <button type="submit" class="btn btn-primary" id="btnAtualizar" {% if lado_bloqueado %} disabled {% endif %}>
                <i class="bi bi-arrow-repeat"></i> Atualizar
            </button>
        </div>

        <!-- Cards das Regi√µes (container limpo: preenchido por JS) -->
        <div class="row g-3" id="cardsContainer"></div>
    </form>

    <!-- Mapa -->
    <h2 class="mt-5">Mapa</h2>
    <div id="map" class="mb-5"></div>
</div>

<footer class="py-3 text-center">
    <p>&copy; 2025 DFS. Todos os direitos reservados.</p>
</footer>

<!-- Modal -->
<div class="modal fade" id="obsModal" tabindex="-1" aria-labelledby="obsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="obsModalLabel">Regi√£o: <span id="modalRegiao"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="obsTexto" class="form-label fw-bold">Observa√ß√µes</label>
        <textarea id="obsTexto" class="form-control" rows="4"></textarea>

        <div class="mt-3">
          <h6 class="fw-bold text-danger">Sugest√µes de aux√≠lio</h6>
          <pre id="sugestoesAuxilio" class="bg-light p-2 rounded"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-success" id="salvarObs">Salvar</button>
      </div>
    </div>
  </div>
</div>
<script>
/* --------------------- Dados iniciais passados pelo Flask --------------------- */
const todasRegioes = {{ todas_regioes | tojson }};
const status = {{ status | tojson }};
const observacoes = {{ observacoes | tojson }};
const dataAtual = "{{ data }}";
let ladoBloqueado = {{ lado_bloqueado | tojson }};
let ladoSugerido = {{ lado_sugerido | tojson }};

let marcadores = {};
let pulsarInterval = {};
let regiaoSelecionada = null;

/* --------------------- Fun√ß√µes auxiliares --------------------- */
function corMarcador(s){
    if(s==="verde") return {cor:"#28a745", opacidade:0.3};
    if(s==="amarelo") return {cor:"#ffc107", opacidade:0.7};
    return {cor:"#dc3545", opacidade:0.8};
}

function atualizarPainelResumo(){
    const painel = document.getElementById("painelResumo");
    painel.innerHTML = "";
    let total=0, verdes=0, amarelas=0, vermelhas=0;
    for(let regiao in status){
        total++;
        if(status[regiao]==="verde") verdes++;
        else if(status[regiao]==="amarelo") amarelas++;
        else if(status[regiao]==="vermelho") vermelhas++;
    }

    const cards = [
        {titulo:"Total de Regi√µes", valor:total, classe:"bg-primary"},
        {titulo:"Verdes", valor:verdes, classe:"bg-success"},
        {titulo:"Amarelas", valor:amarelas, classe:"bg-warning text-dark"},
        {titulo:"Vermelhas", valor:vermelhas, classe:"bg-danger"}
    ];

    cards.forEach(c=>{
        let div = document.createElement("div");
        div.className = "resumo-card " + c.classe + " flex-fill text-center";
        div.style.minWidth="150px";
        div.innerHTML = `<h5>${c.titulo}</h5><p class="fs-4 mb-0">${c.valor}</p>`;
        painel.appendChild(div);
    });
}

/* --------------------- Mapa --------------------- */
const map = L.map('map').setView([-22.14, -51.40], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© OpenStreetMap'
}).addTo(map);

function criarMarcadores(){
    // limpa marcadores antigos
    for(let key in marcadores){
        try { map.removeLayer(marcadores[key]); } catch(e){}
    }
    marcadores = {};

    for(let key in todasRegioes){
        const latlng = todasRegioes[key].coords;
        const estilo = corMarcador(status[key] || "verde");

        let popupTexto = `<b>${key}</b><br>Status: ${status[key] || 'verde'}<br><i>${observacoes[key]||""}</i>`;
        if(status[key]==="amarelo" || status[key]==="vermelho"){
            popupTexto += `<br><b>Dia sem entrega:</b> ${dataAtual}`;
        }

        const marker = L.circle(latlng, {
            radius:800,
            color: estilo.cor,
            fillColor: estilo.cor,
            fillOpacity: estilo.opacidade,
            weight:2
        }).addTo(map).bindPopup(popupTexto);

        marcadores[key] = marker;

        if(status[key]==="amarelo" || status[key]==="vermelho") pulsarMarcador(key);
    }
}

function pulsarMarcador(key){
    const marker = marcadores[key];
    if(!marker) return;
    if(pulsarInterval[key]) clearInterval(pulsarInterval[key]);
    let radius = 800, growing = true;
    pulsarInterval[key] = setInterval(()=>{
        radius += (growing?8:-8);
        if(radius >= 1000) growing = false;
        if(radius <= 800) growing = true;
        marker.setRadius(radius);
    }, 100);
}

/* --------------------- Dist√¢ncia Haversine --------------------- */
function distanciaHaversine(coord1, coord2) {
    const R = 6371;
    const dLat = (coord2[0]-coord1[0]) * Math.PI/180;
    const dLon = (coord2[1]-coord1[1]) * Math.PI/180;
    const lat1 = coord1[0] * Math.PI/180;
    const lat2 = coord2[0] * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +  Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

/* --------------------- Sugest√£o de aux√≠lio --------------------- */
function sugerirAuxilio(regiaoVermelha) {
    const proximas = [];
    const coordR = todasRegioes[regiaoVermelha].coords;
    for (let key in todasRegioes){
        if(key === regiaoVermelha) continue;
        if(status[key] === "verde" || status[key] === "amarelo"){
            proximas.push({regiao: key, dist: distanciaHaversine(coordR, todasRegioes[key].coords)});
        }
    }
    proximas.sort((a,b)=> a.dist - b.dist);
    return proximas.slice(0,3);
}

/* --------------------- Atualizar cards por lado --------------------- */
function atualizarCardsPorLado(ladoSelecionado){
    const container = document.getElementById("cardsContainer");
    container.innerHTML = "";

    for(let regiao in todasRegioes){
        if(!regiao.endsWith(ladoSelecionado)) continue;

        const col = document.createElement("div");
        col.className = "col-6 col-sm-4 col-md-3 col-lg-2";

        const label = document.createElement("label");
        label.className = "card card-regiao shadow-sm p-2 text-center fw-semibold";
        label.dataset.regiao = regiao;

        const input = document.createElement("input");
        input.type = "checkbox";
        input.className = "form-check-input me-1";
        input.name = "atendidas";
        input.value = regiao;
        input.disabled = ladoBloqueado;
        if(status[regiao] === "verde") input.checked = true;

        const spanText = document.createElement("span");
        spanText.textContent = regiao;

        const aviso = document.createElement("span");
        aviso.className = "aviso-obs";
        aviso.title = "Observa√ß√£o";
        aviso.textContent = "‚ö†Ô∏è";

        label.appendChild(input);
        label.appendChild(spanText);
        label.appendChild(aviso);
        col.appendChild(label);
        container.appendChild(col);

        setTimeout(() => label.classList.add("fade-in"), 50);

        // Fun√ß√£o para atualizar cor/pulsar/obs
        label.atualizarPulsar = function(){
            label.classList.remove("pulsar-amarelo","pulsar-vermelho","card-verde","com-obs");
            if(status[regiao] === "amarelo") label.classList.add("pulsar-amarelo");
            else if(status[regiao] === "vermelho") label.classList.add("pulsar-vermelho");
            else label.classList.add("card-verde");

            if(observacoes[regiao] && observacoes[regiao].trim() !== ""){
                label.classList.add("com-obs");
                aviso.style.display = "inline-block";
            } else {
                aviso.style.display = "none";
            }

            if(marcadores[regiao]){
                let estilo = corMarcador(status[regiao]);
                marcadores[regiao].setStyle({color:estilo.cor, fillColor:estilo.cor, fillOpacity:estilo.opacidade});
                if(status[regiao] === "amarelo" || status[regiao] === "vermelho") pulsarMarcador(regiao);
                else if(pulsarInterval[regiao]){ clearInterval(pulsarInterval[regiao]); marcadores[regiao].setRadius(800); }
            }
        };
        label.atualizarPulsar();

        // Modal ao clicar no card (somente se clicar fora do input)
        label.addEventListener("click", (e)=>{
            if(e.target.tagName === "INPUT") return;
            try {
                regiaoSelecionada = regiao;
                document.getElementById("modalRegiao").textContent = regiao;
                document.getElementById("obsTexto").value = observacoes[regiao] || "";

                let sugestoesTexto = "";
                if(status[regiao] === "vermelho"){
                    let sugestoes = sugerirAuxilio(regiao) || [];
                    if(Array.isArray(sugestoes) && sugestoes.length){
                        sugestoesTexto = "Sugest√µes de aux√≠lio (mais pr√≥ximas):\n";
                        sugestoes.forEach(s => {
                            if(s?.regiao && typeof s.dist === "number"){
                                sugestoesTexto += `- ${s.regiao} (${s.dist.toFixed(2)} km)\n`;
                            }
                        });
                    }
                }
                document.getElementById("sugestoesAuxilio").textContent = sugestoesTexto;

                const modal = new bootstrap.Modal(document.getElementById("obsModal"), { 
                    backdrop: "static",
                    keyboard: true 
                });
                modal.show();
            } catch(err){
                console.error("Erro ao abrir modal:", err);
            }
        });
    }
}
        /* --------------------- Listeners principais --------------------- */
    document.getElementById("lado").addEventListener("change", function(){
        const lado = this.value;
        atualizarCardsPorLado(lado);
    });
    
   document.getElementById("selecionarTodosBtn").addEventListener("click", function(){
        const checkboxes = document.querySelectorAll("#cardsContainer input[type='checkbox']:not(:disabled)");
        const algumDesmarcado = Array.from(checkboxes).some(cb => !cb.checked);
    
        checkboxes.forEach(cb => cb.checked = algumDesmarcado);
    });

    
    document.getElementById("salvarObs").addEventListener("click", function(){
        const texto = document.getElementById("obsTexto").value;
        if(!regiaoSelecionada) return;
        observacoes[regiaoSelecionada] = texto;
    
        // atualiza popup do marcador se existir
        if(marcadores[regiaoSelecionada]){
            const estilo = corMarcador(status[regiaoSelecionada] || "verde");
            let popupTexto = `<b>${regiaoSelecionada}</b><br>Status: ${status[regiaoSelecionada] || 'verde'}<br><i>${texto}</i>`;
            if(status[regiaoSelecionada] === "amarelo" || status[regiaoSelecionada] === "vermelho"){
                popupTexto += `<br><b>Dia sem entrega:</b> ${dataAtual}`;
            }
            marcadores[regiaoSelecionada].bindPopup(popupTexto).setStyle({color:estilo.cor, fillColor:estilo.cor, fillOpacity:estilo.opacidade});
        }
    
        // grava no servidor
        fetch("/salvar_obs", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ regiao: regiaoSelecionada, obs: texto })
        }).then(resp => resp.json())
          .then(data => {
              // atualiza visual local
              document.querySelector(`#cardsContainer label[data-regiao='${regiaoSelecionada}']`).atualizarPulsar();
              atualizarPainelResumo();
          })
          .catch(err => console.error(err));
    
        bootstrap.Modal.getInstance(document.getElementById("obsModal")).hide();
    });
    
    /* --------------------- Form submit (atualizar entregas) --------------------- */
    document.getElementById("form-regioes").addEventListener("submit", function(e){
        e.preventDefault();
    
        if(ladoBloqueado){
            alert("Atualiza√ß√£o j√° realizada hoje para este lado. Apenas observa√ß√µes podem ser alteradas.");
            return;
        }
    
        const form = e.currentTarget;
        const formData = new FormData(form);
    
        // atualizar status local antes do envio (para visual imediato)
        const atendidas = formData.getAll("atendidas");
        const lado = formData.get("lado");
        for(const regiao in todasRegioes){
            if(!regiao.endsWith(lado)) continue;
            if(atendidas.includes(regiao)) status[regiao] = "verde";
            else {
                if(status[regiao] === "verde") status[regiao] = "amarelo";
                else if(status[regiao] === "amarelo") status[regiao] = "vermelho";
            }
        }
        // atualiza cards e marcadores locais
        atualizarCardsPorLado(lado);
        criarMarcadores();
        atualizarPainelResumo();
    
        // envia ao backend
        fetch("/", { method: "POST", body: formData })
            .then(async resp => {
                if(resp.ok){
                    // sucesso: recarrega p√°gina para pegar estado definitivo do backend (e mensagens)
                    location.reload();
                } else {
                    // tenta mostrar erro do backend
                    let j;
                    try { j = await resp.json(); }
                    catch(e){ j = { erro: "Erro ao atualizar" }; }
                    alert(j.erro || j.error || "N√£o foi poss√≠vel atualizar.");
                }
            })

    });

/* --------------------- Inicializa√ß√£o --------------------- */
criarMarcadores();
atualizarCardsPorLado(ladoSugerido || "A");
atualizarPainelResumo();
</script>


</body>
</html>


















