<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle da Distribuição</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

<!-- Header -->
<header class="header-custom py-3">
    <div class="container text-center">
        <h1 class="mb-1">GERAI</h1>
        <img src="{{ url_for('static', filename='envelope.png') }}" alt="Logo" class="logo-header" style="height:48px">

        <!-- Formulário EPTC -->
        <form method="POST" class="row g-2 justify-content-center mt-3">
            <div class="col-auto">
                <label for="total_objetos" class="col-form-label">Qtd. Objetos:</label>
            </div>
            <div class="col-auto">
                <input type="number" name="total_objetos" id="total_objetos" class="form-control" required>
            </div>

            <div class="col-auto">
                <label for="ausentes" class="col-form-label">Ausentes até o momento:</label>
            </div>
            <div class="col-auto">
                <input type="number" name="ausentes" id="ausentes" class="form-control" required>
            </div>

            <div class="col-auto">
                <button type="submit" class="btn btn-warning fw-semibold">
                    <i class="bi bi-calculator"></i> Calcular EPTC
                </button>
            </div>
        </form>

        <!-- Resultado -->
        {% if eptc_resultado %}
        <div class="alert alert-info mt-3 mb-0">
            <strong>📊 EPTC Previsto:</strong> {{ eptc_resultado }}% |
            <strong>🔄 Limite Ausentes:</strong> {{ limite_ausentes }} |
            <strong>🎯 1ª Tentativa:</strong> {{ primeira_tentativa }}
        </div>
        {% endif %}
    </div>
</header>

<div class="container my-4">
    <p class="text-muted text-center">Data atual: <strong>{{ data }}</strong></p>

    <!-- Painel Resumo -->
    <div id="painelResumo" class="d-flex flex-wrap mb-4 gap-3 justify-content-center">
        <!-- Cards do resumo via JS -->
    </div>

    <!-- Mensagem sobre o lado do dia -->
    {% if lado_bloqueado %}
    <p class="text-danger text-center fw-semibold">
        As entregas do lado {{ lado_sugerido }} já foram atualizadas hoje. Você só pode alterar observações.
    </p>
    {% else %}
    <p class="text-success text-center fw-semibold">
        Atualize as entregas do lado {{ lado_sugerido }} hoje.
    </p>
    {% endif %}

    {% if mensagem %}
      {% if "já foi atualizado" in mensagem %}
        <div class="alert alert-warning alert-dismissible fade show mt-3" role="alert">
          <strong>⚠ Atenção!</strong> {{ mensagem }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% else %}
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
          <strong>✔ Sucesso!</strong> {{ mensagem }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
    {% endif %}


    <!-- Formulário único -->
    <form method="POST" id="form-regioes" class="mb-4">
        <div class="mb-3 text-center">
            <label for="lado" class="form-label fw-semibold me-2">Selecione o lado:</label>
            <select class="form-select w-auto d-inline-block" id="lado" name="lado" {% if lado_bloqueado %} disabled {% endif %}>
                <option value="A" {% if lado_sugerido == "A" %}selected{% endif %}>Lado A</option>
                <option value="B" {% if lado_sugerido == "B" %}selected{% endif %}>Lado B</option>
            </select>
        </div>

        <!-- Botões de ação -->
        <div class="d-flex justify-content-between mb-3">
            <button type="button" class="btn btn-outline-secondary" id="selecionarTodosBtn" {% if lado_bloqueado %} disabled {% endif %}>
                <i class="bi bi-check2-square"></i> Selecionar Todos
            </button>
            <button type="submit" class="btn btn-primary" id="btnAtualizar" {% if lado_bloqueado %} disabled {% endif %}>
                <i class="bi bi-arrow-repeat"></i> Atualizar
            </button>
        </div>

        <!-- Cards das Regiões (container limpo: preenchido por JS) -->
        <div class="row g-3" id="cardsContainer"></div>
    </form>

    <!-- Mapa -->
    <h2 class="mt-5">Mapa</h2>
    <div id="map" class="mb-5"></div>
</div>

<footer class="py-3 text-center">
    <p>&copy; 2025 DFS. Todos os direitos reservados.</p>
</footer>

<!-- Modal -->
<div class="modal fade" id="obsModal" tabindex="-1" aria-labelledby="obsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-3">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="obsModalLabel">Região: <span id="modalRegiao"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="obsTexto" class="form-label fw-bold">Observações</label>
        <textarea id="obsTexto" class="form-control" rows="4"></textarea>

        <div class="mt-3">
          <h6 class="fw-bold text-danger">Sugestões de auxílio</h6>
          <pre id="sugestoesAuxilio" class="bg-light p-2 rounded"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-success" id="salvarObs">Salvar</button>
      </div>
    </div>
  </div>
</div>
<script>
/* --------------------- Dados iniciais passados pelo Flask --------------------- */
const todasRegioes = {{ todas_regioes | tojson }};
const status = {{ status | tojson }};
const observacoes = {{ observacoes | tojson }};
const dataAtual = "{{ data }}";
let ladoBloqueado = {{ lado_bloqueado | tojson }};
let ladoSugerido = {{ lado_sugerido | tojson }};

let marcadores = {};
let pulsarInterval = {};
let regiaoSelecionada = null;

/* --------------------- Funções auxiliares --------------------- */
function corMarcador(s){
    if(s==="verde") return {cor:"#28a745", opacidade:0.3};
    if(s==="amarelo") return {cor:"#ffc107", opacidade:0.7};
    return {cor:"#dc3545", opacidade:0.8};
}

function atualizarPainelResumo(){
    const painel = document.getElementById("painelResumo");
    painel.innerHTML = "";
    let total=0, verdes=0, amarelas=0, vermelhas=0;
    for(let regiao in status){
        total++;
        if(status[regiao]==="verde") verdes++;
        else if(status[regiao]==="amarelo") amarelas++;
        else if(status[regiao]==="vermelho") vermelhas++;
    }

    const cards = [
        {titulo:"Total de Regiões", valor:total, classe:"bg-primary"},
        {titulo:"Verdes", valor:verdes, classe:"bg-success"},
        {titulo:"Amarelas", valor:amarelas, classe:"bg-warning text-dark"},
        {titulo:"Vermelhas", valor:vermelhas, classe:"bg-danger"}
    ];

    cards.forEach(c=>{
        let div = document.createElement("div");
        div.className = "resumo-card " + c.classe + " flex-fill text-center";
        div.style.minWidth="150px";
        div.innerHTML = `<h5>${c.titulo}</h5><p class="fs-4 mb-0">${c.valor}</p>`;
        painel.appendChild(div);
    });
}

/* --------------------- Mapa --------------------- */
const map = L.map('map').setView([-22.14, -51.40], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
}).addTo(map);

function criarMarcadores(){
    // limpa marcadores antigos
    for(let key in marcadores){
        try { map.removeLayer(marcadores[key]); } catch(e){}
    }
    marcadores = {};

    for(let key in todasRegioes){
        const latlng = todasRegioes[key].coords;
        const estilo = corMarcador(status[key] || "verde");

        let popupTexto = `<b>${key}</b><br>Status: ${status[key] || 'verde'}<br><i>${observacoes[key]||""}</i>`;
        if(status[key]==="amarelo" || status[key]==="vermelho"){
            popupTexto += `<br><b>Dia sem entrega:</b> ${dataAtual}`;
        }

        const marker = L.circle(latlng, {
            radius:800,
            color: estilo.cor,
            fillColor: estilo.cor,
            fillOpacity: estilo.opacidade,
            weight:2
        }).addTo(map).bindPopup(popupTexto);

        marcadores[key] = marker;

        if(status[key]==="amarelo" || status[key]==="vermelho") pulsarMarcador(key);
    }
}

function pulsarMarcador(key){
    const marker = marcadores[key];
    if(!marker) return;
    if(pulsarInterval[key]) clearInterval(pulsarInterval[key]);
    let radius = 800, growing = true;
    pulsarInterval[key] = setInterval(()=>{
        radius += (growing?8:-8);
        if(radius >= 1000) growing = false;
        if(radius <= 800) growing = true;
        marker.setRadius(radius);
    }, 100);
}

/* --------------------- Distância Haversine --------------------- */
function distanciaHaversine(coord1, coord2) {
    const R = 6371;
    const dLat = (coord2[0]-coord1[0]) * Math.PI/180;
    const dLon = (coord2[1]-coord1[1]) * Math.PI/180;
    const lat1 = coord1[0] * Math.PI/180;
    const lat2 = coord2[0] * Math.PI/180;
    const a = Math.sin(dLat/2)**2 +  Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

/* --------------------- Sugestão de auxílio --------------------- */
function sugerirAuxilio(regiaoVermelha) {
    const proximas = [];
    const coordR = todasRegioes[regiaoVermelha].coords;
    for (let key in todasRegioes){
        if(key === regiaoVermelha) continue;
        if(status[key] === "verde" || status[key] === "amarelo"){
            proximas.push({regiao: key, dist: distanciaHaversine(coordR, todasRegioes[key].coords)});
        }
    }
    proximas.sort((a,b)=> a.dist - b.dist);
    return proximas.slice(0,3);
}

/* --------------------- Atualizar cards por lado --------------------- */
function atualizarCardsPorLado(ladoSelecionado){
    const container = document.getElementById("cardsContainer");
    container.innerHTML = "";

    for(let regiao in todasRegioes){
        if(!regiao.endsWith(ladoSelecionado)) continue;

        const col = document.createElement("div");
        col.className = "col-6 col-sm-4 col-md-3 col-lg-2";

        const label = document.createElement("label");
        label.className = "card card-regiao shadow-sm p-2 text-center fw-semibold";
        label.dataset.regiao = regiao;

        const input = document.createElement("input");
        input.type = "checkbox";
        input.className = "form-check-input me-1";
        input.name = "atendidas";
        input.value = regiao;
        input.disabled = ladoBloqueado;
        if(status[regiao] === "verde") input.checked = true;

        const spanText = document.createElement("span");
        spanText.textContent = regiao;

        const aviso = document.createElement("span");
        aviso.className = "aviso-obs";
        aviso.title = "Observação";
        aviso.textContent = "⚠️";

        label.appendChild(input);
        label.appendChild(spanText);
        label.appendChild(aviso);
        col.appendChild(label);
        container.appendChild(col);

        setTimeout(() => label.classList.add("fade-in"), 50);

        // Função para atualizar cor/pulsar/obs
        label.atualizarPulsar = function(){
            label.classList.remove("pulsar-amarelo","pulsar-vermelho","card-verde","com-obs");
            if(status[regiao] === "amarelo") label.classList.add("pulsar-amarelo");
            else if(status[regiao] === "vermelho") label.classList.add("pulsar-vermelho");
            else label.classList.add("card-verde");

            if(observacoes[regiao] && observacoes[regiao].trim() !== ""){
                label.classList.add("com-obs");
                aviso.style.display = "inline-block";
            } else {
                aviso.style.display = "none";
            }

            if(marcadores[regiao]){
                let estilo = corMarcador(status[regiao]);
                marcadores[regiao].setStyle({color:estilo.cor, fillColor:estilo.cor, fillOpacity:estilo.opacidade});
                if(status[regiao] === "amarelo" || status[regiao] === "vermelho") pulsarMarcador(regiao);
                else if(pulsarInterval[regiao]){ clearInterval(pulsarInterval[regiao]); marcadores[regiao].setRadius(800); }
            }
        };
        label.atualizarPulsar();

        // Modal ao clicar no card (somente se clicar fora do input)
        label.addEventListener("click", (e)=>{
            if(e.target.tagName === "INPUT") return;
            try {
                regiaoSelecionada = regiao;
                document.getElementById("modalRegiao").textContent = regiao;
                document.getElementById("obsTexto").value = observacoes[regiao] || "";

                let sugestoesTexto = "";
                if(status[regiao] === "vermelho"){
                    let sugestoes = sugerirAuxilio(regiao) || [];
                    if(Array.isArray(sugestoes) && sugestoes.length){
                        sugestoesTexto = "Sugestões de auxílio (mais próximas):\n";
                        sugestoes.forEach(s => {
                            if(s?.regiao && typeof s.dist === "number"){
                                sugestoesTexto += `- ${s.regiao} (${s.dist.toFixed(2)} km)\n`;
                            }
                        });
                    }
                }
                document.getElementById("sugestoesAuxilio").textContent = sugestoesTexto;

                const modal = new bootstrap.Modal(document.getElementById("obsModal"), { 
                    backdrop: "static",
                    keyboard: true 
                });
                modal.show();
            } catch(err){
                console.error("Erro ao abrir modal:", err);
            }
        });
    }
}
        /* --------------------- Listeners principais --------------------- */
    document.getElementById("lado").addEventListener("change", function(){
        const lado = this.value;
        atualizarCardsPorLado(lado);
    });
    
    document.getElementById("selecionarTodosBtn").addEventListener("click", function(){
        document.querySelectorAll("#cardsContainer input[type='checkbox']").forEach(cb=>{
            if(!cb.disabled) cb.checked = true;
        });
    });
    
    document.getElementById("salvarObs").addEventListener("click", function(){
        const texto = document.getElementById("obsTexto").value;
        if(!regiaoSelecionada) return;
        observacoes[regiaoSelecionada] = texto;
    
        // atualiza popup do marcador se existir
        if(marcadores[regiaoSelecionada]){
            const estilo = corMarcador(status[regiaoSelecionada] || "verde");
            let popupTexto = `<b>${regiaoSelecionada}</b><br>Status: ${status[regiaoSelecionada] || 'verde'}<br><i>${texto}</i>`;
            if(status[regiaoSelecionada] === "amarelo" || status[regiaoSelecionada] === "vermelho"){
                popupTexto += `<br><b>Dia sem entrega:</b> ${dataAtual}`;
            }
            marcadores[regiaoSelecionada].bindPopup(popupTexto).setStyle({color:estilo.cor, fillColor:estilo.cor, fillOpacity:estilo.opacidade});
        }
    
        // grava no servidor
        fetch("/salvar_obs", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ regiao: regiaoSelecionada, obs: texto })
        }).then(resp => resp.json())
          .then(data => {
              // atualiza visual local
              document.querySelector(`#cardsContainer label[data-regiao='${regiaoSelecionada}']`).atualizarPulsar();
              atualizarPainelResumo();
          })
          .catch(err => console.error(err));
    
        bootstrap.Modal.getInstance(document.getElementById("obsModal")).hide();
    });
    
    /* --------------------- Form submit (atualizar entregas) --------------------- */
    document.getElementById("form-regioes").addEventListener("submit", function(e){
        e.preventDefault();
    
        if(ladoBloqueado){
            alert("Atualização já realizada hoje para este lado. Apenas observações podem ser alteradas.");
            return;
        }
    
        const form = e.currentTarget;
        const formData = new FormData(form);
    
        // atualizar status local antes do envio (para visual imediato)
        const atendidas = formData.getAll("atendidas");
        const lado = formData.get("lado");
        for(const regiao in todasRegioes){
            if(!regiao.endsWith(lado)) continue;
            if(atendidas.includes(regiao)) status[regiao] = "verde";
            else {
                if(status[regiao] === "verde") status[regiao] = "amarelo";
                else if(status[regiao] === "amarelo") status[regiao] = "vermelho";
            }
        }
        // atualiza cards e marcadores locais
        atualizarCardsPorLado(lado);
        criarMarcadores();
        atualizarPainelResumo();
    
        // envia ao backend
        fetch("/", { method: "POST", body: formData })
            .then(async resp => {
                if(resp.ok){
                    // sucesso: recarrega página para pegar estado definitivo do backend (e mensagens)
                    location.reload();
                } else {
                    // tenta mostrar erro do backend
                    let j;
                    try { j = await resp.json(); }
                    catch(e){ j = { erro: "Erro ao atualizar" }; }
                    alert(j.erro || j.error || "Não foi possível atualizar.");
                }
            })

    });

/* --------------------- Inicialização --------------------- */
criarMarcadores();
atualizarCardsPorLado(ladoSugerido || "A");
atualizarPainelResumo();
</script>


</body>
</html>










